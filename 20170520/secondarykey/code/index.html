<!DOCTYPE html>
<!-- saved from url=(0073)http://shizuoka-go.appspot.com/entry/6fdfa8bd-7fa6-4d73-b990-af10b88c59cb -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="静岡でGo言語の勉強会を行っています">
    <meta name="author" content="Shizuoka.go">
    <meta name="keywords" content="静岡,勉強会,golang,Go言語">

    <title>Goのハマりどころにハマる男 [Shizuoka.go]</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./index_files/icon">
    <link rel="stylesheet" href="./index_files/material.indigo-blue.min.css">

    <link rel="stylesheet" href="./index_files/styles.css">

  </head>

  <body>
    <div class="demo-blog demo-blog--blogpost mdl-layout mdl-js-layout has-drawer is-upgraded">
      <main class="mdl-layout__content">

        <div class="demo-back">
          <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="javascript:history.back()" title="back" role="button">
            <i class="material-icons" role="presentation">arrow_back</i>
          </a>

          <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon right" href="http://shizuoka-go.appspot.com/" title="home" role="button">
            <i class="material-icons" role="presentation">home</i>
          </a>
        </div>

        <div class="demo-blog__posts mdl-grid">
          <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

            <div class="mdl-card__media mdl-color-text--grey-50" style="background-image:url(&#39;/index_files/bedf2437-3279-44f6-8406-21d35a0e7463.jpg&#39;);">
              <h3 class="title">Goのハマりどころにハマる男</h3>
            </div>



            <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

              <img class="avatar" src="./index_files/117140318697099556325" width="48" height="48" onerror="this.src=&#39;/static/images/somebody.jpg&#39;">

              <div>
                  <strong style="width:100%;"> secondarykey </strong>
                  <span> 2016/06/12 18:11 </span>
              </div>



            </div>

            <div class="mdl-color-text--grey-700 mdl-card" style="padding-left:20px;padding-right:20px;padding:bottom:50px;width:100%;">



        
          
  <h1 id="TOC_1.">argenのerrorでハマった</h1>
  <p class="link"><a href="http://shizuoka-go.appspot.com/entry/587c3ee1-9dd1-4fc0-9edc-7d8630058b5b" target="_blank">先日少し書いたメモツール</a></p>
  
  <p>
    作ってて、ハマったので書いておきます
  </p>
  

  
  <p>
    とあるURLにアクセスがあるとそのIDを元にargenのFind()を使用して検索します
  </p>
  

  <div class="code" contenteditable="true" spellcheck="false">


<pre><span num="175">    //START HL001</span>
<span num="176">    var err error</span>
<span num="177">    var m *Memo</span>
<span num="178">    m, err = getMemo(r)</span>
<span num="179">    if err != nil {</span>
<span num="180">        http.Error(w, err.Error(), http.StatusInternalServerError)</span>
<span num="181">        return</span>
<span num="182">    }</span>
<span num="183"></span>
<span num="184">    msg := "success " + r.Method</span>
<span num="185">    code := 200</span>
<span num="186">    //END HL001</span>
</pre>


</div>

  
  <p>
    ※getMemo()の中身はargenが出力したFind()をしています
  </p>
  

  
  <p>
    同スコープ内でリクエストのメソッドで更新処理や削除処理を行います
  </p>
  

  <div class="code" contenteditable="true" spellcheck="false">


<pre><span num="196">        //START HL002</span>
<span num="197">    } else if r.Method == "POST" {</span>
<span num="198"></span>
<span num="199">        r.ParseForm()</span>
<span num="200"></span>
<span num="201">        m.Title = r.FormValue("title")</span>
<span num="202">        m.Content = r.FormValue("content")</span>
<span num="203"></span>
<span num="204">        _, err = m.Save()</span>
<span num="205"></span>
<span num="206">    } else if r.Method == "DELETE" {</span>
<span num="207">        //END HL002</span>
</pre>


</div>

  
  <p>
    エラー処理面倒なので一緒にします
  </p>
  

  <div class="code" contenteditable="true" spellcheck="false">


<pre><span num="217">    //START HL003</span>
<span num="218">    if err != nil {</span>
<span num="219">        msg = err.Error()</span>
<span num="220">        code = 500</span>
<span num="221">    }</span>
<span num="222">    //END HL003</span>
</pre>


</div>

  
  <p>
    そのあとで面倒なので共通のエラー処理をします。
  </p>
  

  
  <p>
    そうすると、if文を抜けてerr.Error()呼び出しの中身でnil addressのエラーを喰らいました&gt;&lt;
  </p>
  


        
          
  <h1 id="TOC_2.">ハマったところ</h1>
  
  <h2 id="TOC_2.1.">nilじゃないのにError()で落ちる挙動</h2>
  
  
  <p>
    HL003で、nilなのにError()が呼び出せてポインタがnilと言われてしまったので、スコープやら、エクステント辺りだと思って調べていたら、どうもレシーバがnilなパターンがあるらしいことを知る
  </p>
  

  <h3 id="TOC_2.1.1.">(参考資料)メソッド内でレシーバ(this, self)がnilでないことをチェックすることに意味がある</h3>
  <p class="link"><a href="http://www.yunabe.jp/docs/golang_pitfall.html#this-selfnil" target="_blank">www.yunabe.jp/docs/golang_pitfall.html#this-selfnil</a></p>


  <h2 id="TOC_2.2.">nilじゃないけどnil</h2>
  
  
  <p>
    nilが単純なnilではないと知る
  </p>
  

  <h3 id="TOC_2.2.1.">(参考資料)絶対ハマる、不思議なnil</h3>
  <p class="link"><a href="http://qiita.com/umisama/items/e215d49138e949d7f805" target="_blank">qiita.com/umisama/items/e215d49138e949d7f805</a></p>



        
          
  <h1 id="TOC_3.">原因</h1>
  
  
  <p>
    HL002のエラー処理の部分を共通化(HL003)したくて、スコープ内共通でerrを宣言したのですが、argenを使った時のFind() はerrorを返して、Save(),Destroy()時は*ar.Errorsを返していて、上記理由でハマってしまいました。
  </p>
  


        
          
  <h1 id="TOC_4.">対策</h1>
  
  <h2 id="TOC_4.1.">そのスコープで処理をする</h2>
  
  
  <p>
    HL002の部分で共通化をあきらめて個別の変数にすれば大丈夫でした


    なので、もうちょっと関数化するべきなのかな・・・
  </p>
  


  <h2 id="TOC_4.2.">宣言を変える</h2>
  
  
  <p>
    出力されたxxx_gen.goにあるSave()、Destroy()が返している*ar.Errorsをerrorで宣言すると動作しました
  </p>
  



        
          
  <h1 id="TOC_5.">どれが正しいのかな？</h1>
  
  <ul>
  
    <li>Find()とSave()でエラーの型が違う</li>
  
    <li>そもそも個別のスコープでerror処理するべき</li>
  
  </ul>

  
  <p>
    他にどうするべきなのか悩ましいので、もう少しまとまったらargenにPRしてみようと思います
  </p>
  


        

            </div>

          </div>

        </div>

        <footer class="mdl-mini-footer">
          <div class="mdl-mini-footer--left-section">
            <button class="mdl-mini-footer--social-btn social-btn social-btn__twitter" onclick="tweet();">
              <span class="visuallyhidden">Twitter</span>
            </button>
            <button class="mdl-mini-footer--social-btn social-btn social-btn__blogger" onclick="facebook();">
              <span class="visuallyhidden">Facebook</span>
            </button>
            <button class="mdl-mini-footer--social-btn social-btn social-btn__gplus" onclick="gplus();">
              <span class="visuallyhidden">Google Plus</span>
            </button>
          </div>

        </footer>
      </main>

      <div class="mdl-layout__obfuscator"></div>

    </div>

    <a href="javascript:window.scrollTo(0,0);" id="top" class="mdl-button mdl-button--fab mdl-js-button mdl-js-ripple-effect mdl-color--accent mdl-color-text--white"><i class="material-icons">vertical_align_top</i></a>

<script>
    function tweet() {
        var address = location.href;
        var title = document.title;
        var href = "http://twitter.com/share?count=horizontal&amp;original_referer=" + address + "&amp;text=" + title + "&amp;url=" + address;
        window.open(href,'tweetwindow','width=550, height=450,personalbar=0,toolbar=0,scrollbars=1,resizable=1');
        return false;
    }

    function facebook() {
        var address = location.href;
        window.open("http://www.facebook.com/share.php?u=" + address,"facebookwindow","idth=550, height=450,personalbar=0,toolbar=0,scrollbars=1,resizable=1");
        return false;
    }

    function gplus() {
        var address = location.href;
        window.open("https://plus.google.com/share?url=" + address,"gpluswindow","idth=550, height=450,personalbar=0,toolbar=0,scrollbars=1,resizable=1");
        return false;
    }
</script>

  

</body></html>
